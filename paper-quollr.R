# Generated by `rjournal_pdf_article()` using `knitr::purl()`: do not edit by hand
# Please edit paper-quollr.Rmd to modify this file

## ----setup, include=FALSE-----------------------------------------------------
options(repos = "https://cloud.r-project.org") ## set up CRAN mirror
knitr::opts_chunk$set(
  echo = FALSE, 
  cache=FALSE, 
  message=FALSE, 
  warning=FALSE,
  out.width = "100%")



## ----load-libraries-----------------------------------------------------------
library(quollr)
library(tibble)
library(knitr)
library(kableExtra)
library(ggplot2)
library(dplyr)
library(ggbeeswarm)
library(patchwork)
library(Rtsne)
library(uwot)
library(readr)
library(tools)
library(cardinalR)

set.seed(20240110)


## ----plot-theme---------------------------------------------------------------
theme_set(theme_linedraw() +
   theme(
     aspect.ratio = 1,
     plot.background = element_rect(fill = 'transparent', colour = NA),
     plot.title = element_text(size = 7, hjust = 0.5, vjust = -0.5),
     panel.background = element_rect(fill = 'transparent', 
                                     colour = NA),
     panel.grid.major = element_blank(), 
     panel.grid.minor = element_blank(), 
     axis.title.x = element_blank(), axis.title.y = element_blank(),
     axis.text.x = element_blank(), axis.ticks.x = element_blank(),
     axis.text.y = element_blank(), axis.ticks.y = element_blank(),
     legend.background = element_rect(fill = 'transparent', 
                                      colour = NA),
     legend.key = element_rect(fill = 'transparent', 
                               colour = NA),
     legend.position = "none", 
     legend.title = element_text(size=5), 
     legend.text = element_text(size=4),
     legend.key.height = unit(0.25, 'cm'),
     legend.key.width = unit(0.25, 'cm')
   )

)


## -----------------------------------------------------------------------------
#| label: import-scripts
source("scripts/additional_functions.R")


## -----------------------------------------------------------------------------
#| label: scurve-diff-umap-layouts

scurve_umap1 <- read_rds("data/scurve/s_curve_noise_umap.rds")

nldr_scaled_obj <- gen_scaled_data(
  nldr_data = scurve_umap)
umap_scaled1 <- nldr_scaled_obj$scaled_nldr

nldr1 <- umap_scaled1 |>
  ggplot(aes(x = emb1,
             y = emb2))+
  geom_point(alpha=0.1, size=1, colour='#e41a1c') +
  theme(aspect.ratio = 1)

scurve_umap2 <- read_rds("data/scurve/s_curve_noise_umap2.rds")

nldr_scaled_obj2 <- gen_scaled_data(
  nldr_data = scurve_umap2)
umap_scaled2 <- nldr_scaled_obj2$scaled_nldr

nldr2 <- umap_scaled2 |>
  ggplot(aes(x = emb1,
             y = emb2))+
  geom_point(alpha=0.1, size=1, colour='#ff7f00') +
  theme(aspect.ratio = 1)

scurve_umap3 <- read_rds("data/scurve/s_curve_noise_umap3.rds")

nldr_scaled_obj3 <- gen_scaled_data(
  nldr_data = scurve_umap3)
umap_scaled3 <- nldr_scaled_obj3$scaled_nldr

nldr3 <- umap_scaled3 |>
  ggplot(aes(x = emb1,
             y = emb2))+
  geom_point(alpha=0.1, size=1, colour='#4daf4a') +
  theme(aspect.ratio = 1)

scurve_umap4 <- read_rds("data/scurve/s_curve_noise_umap4.rds")

nldr_scaled_obj4 <- gen_scaled_data(
  nldr_data = scurve_umap4)
umap_scaled4 <- nldr_scaled_obj4$scaled_nldr

nldr4 <- umap_scaled4 |>
  ggplot(aes(x = emb1,
             y = emb2))+
  geom_point(alpha=0.1, size=1, colour='#a65628') +
  theme(aspect.ratio = 1)

scurve_umap5 <- read_rds("data/scurve/s_curve_noise_umap5.rds")

nldr_scaled_obj5 <- gen_scaled_data(
  nldr_data = scurve_umap5)
umap_scaled5 <- nldr_scaled_obj5$scaled_nldr

nldr5 <- umap_scaled5 |>
  ggplot(aes(x = emb1,
             y = emb2))+
  geom_point(alpha=0.1, size=1, colour='#636363') +
  theme(aspect.ratio = 1)

scurve_umap6 <- read_rds("data/scurve/s_curve_noise_umap6.rds")

nldr_scaled_obj6 <- gen_scaled_data(
  nldr_data = scurve_umap6)
umap_scaled6 <- nldr_scaled_obj6$scaled_nldr

nldr6 <- umap_scaled6 |>
  ggplot(aes(x = emb1,
             y = emb2))+
  geom_point(alpha=0.1, size=1, colour='#984ea3') +
  theme(aspect.ratio = 1)


## -----------------------------------------------------------------------------
nldr1 + nldr2 + nldr3 + 
  nldr4 + nldr5 + nldr6 +
  plot_layout(ncol = 3)


## -----------------------------------------------------------------------------
package_dependencies("quollr")


## ----echo=TRUE----------------------------------------------------------------
fit_highd_model(
  highd_data = scurve, 
  nldr_data = scurve_umap, 
  bin1 = 15, 
  q = 0.1, 
  benchmark_highdens = 5)


## ----echo=TRUE----------------------------------------------------------------
scurve_umap_obj <- gen_scaled_data(nldr_data = scurve_umap)

scurve_umap_obj


## ----echo=TRUE----------------------------------------------------------------
calc_bins_y(
  nldr_obj = scurve_umap_obj, 
  bin1 = 15, 
  q = 0.1)


## ----echo=TRUE----------------------------------------------------------------
hb_obj <- hex_binning(
  nldr_obj = scurve_umap_obj, 
  bin1 = 15, 
  q = 0.1)


## -----------------------------------------------------------------------------
#| label: code-illustration
# Code to draw illustration for notation
## hexagon binning to have regular hexagons
hb_obj_notation <- hex_binning(
  nldr_obj = scurve_umap_obj, 
  bin1 = 9, 
  q = 0.1)

a1_temp <- hb_obj_notation$a1
a2_temp <- hb_obj_notation$a2
l_temp <- quad(a=3, b = 2 * a2_temp, c = -(a2_temp^2 + a1_temp^2))

## Data set with all centroids
all_centroids_df_temp <- hb_obj_notation$centroids
hex_grid_temp <- hb_obj_notation$hex_poly

hex_grid_temp45 <- hex_grid_temp |> 
  filter(hex_poly_id == 45)

start_pt <- all_centroids_df_temp |> 
  filter(hexID == 1)
d_rect <- tibble(x1min = 0, 
                 x1max = 1,
                 x2min = 0,
                 x2max = diff(scurve_umap_obj$lim2)/diff(scurve_umap_obj$lim1)) # x2max = r2

# To move the rectangle to ignore the overlap with the centroids
# rect_adj <- tibble(x1 = 0.03, x2 = 0.03)
rect_adj <- tibble(x1 = -0.03, x2 = 0.03)


a1 <- tibble(x = all_centroids_df_temp$c_x[4],
             xend = all_centroids_df_temp$c_x[5],
             y = all_centroids_df_temp$c_y[21],
             yend = all_centroids_df_temp$c_y[21],
             label = expression(a[1]))
a2 <- tibble(x = all_centroids_df_temp$c_x[25],
             xend = all_centroids_df_temp$c_x[25],
             y = all_centroids_df_temp$c_y[25],
             yend = all_centroids_df_temp$c_y[33],
             label = expression(a[2]))
l <- tibble(x = hex_grid_temp45$x[2],
            xend = hex_grid_temp45$x[3],
            y = hex_grid_temp45$y[2],
            yend = hex_grid_temp45$y[3],
            label = expression(l))

hex_param_vis <- ggplot() + 
    geom_polygon(data = hex_grid_temp, 
                        aes(x = x, 
                            y = y, 
                            group = hex_poly_id),
                 fill = "white", 
                 color = "#bdbdbd") +
    geom_point(data = all_centroids_df_temp, aes(
      x = c_x, 
      y = c_y), 
      color = "#31a354", size = 0.9) +
    geom_point(data = start_pt, aes(x = c_x, 
                                    y = c_y), 
               color = "black") + 
    geom_rect(data=d_rect, 
              aes(xmin = x1min - rect_adj$x1,# - rect_adj$s1, 
                  xmax = x1max - rect_adj$x1,# - rect_adj$s1, 
                  ymin = x2min - rect_adj$x2,# - rect_adj$s2, 
                  ymax = x2max - rect_adj$x2),# - rect_adj$s2), 
              fill = "white", 
              color = "black", 
              alpha = 0, 
              linewidth = 0.7) +
    geom_point(data=d_rect, aes(x=x1min - rect_adj$x1, 
                                y=x2min - rect_adj$x2)) + 
    geom_point(data=d_rect, aes(x=x1max - rect_adj$x1, 
                                y=x2min - rect_adj$x2)) + 
    geom_point(data=d_rect, aes(x=x1min - rect_adj$x1, 
                                y=x2max - rect_adj$x2)) + 
    annotate("text", x=d_rect$x1min - rect_adj$x1, 
                     y=d_rect$x2min - rect_adj$x2,
                     label = "(0,0)", 
             hjust=-0.1, vjust=-0.3) + 
    annotate("text", x=d_rect$x1max - rect_adj$x1, 
                     y=d_rect$x2min - rect_adj$x2,
                     label = "(0,1)", 
             hjust=1.1, vjust=-0.3) + 
    annotate("text", x=d_rect$x1min - rect_adj$x1, 
                     y=d_rect$x2max - rect_adj$x2,
                     label = expression(group("(", 
                        list(0, y[2][max]),")")), 
            hjust=-0.1, vjust=1.2) + 
    geom_segment(data=d_rect, aes(
      x = x1min  - rect_adj$x1, # 0 - 0.03, 
      y = -0.31, 
      xend = x1max - rect_adj$x1, #1 - 0.03, 
      yend = -0.31), #-0.35),
      arrow = arrow(length = unit(0.03, "npc"),
                               ends = "both"), 
                 color = "black")+
    annotate("text", x=0.5, y=-0.36, 
             label = expression(r[1]), color = "black") +
    geom_segment(data=d_rect, aes(
      x = -0.25, 
      y = x2min - rect_adj$x2, #0 - 0.05, 
      xend = -0.25, 
      yend = x2max - rect_adj$x2), #r2 - 0.05),
      arrow = arrow(length = unit(0.03, "npc"),
                       ends = "both"), 
                 color = "black")+ 
    annotate("text", x=-0.3, y=0.4, 
             label = expression(r[2]), color = "black") +
    geom_segment(data = a1, aes(
      x = x, #-0.1 + 0.2087578, 
      y = y, #-0.15, 
      xend = xend, #-0.1 + 0.2087578*2, 
      yend = yend), #-0.15),
      arrow = arrow(length = unit(0.03, "npc"),
        ends = "both"), 
        color = "black")+ # a1 = 0.2087578
    annotate("text", 
             x=(a1$x+a1$xend)/2, 
             y=a1$y, 
             label = expression(a[1]), 
             color = "black",
             vjust = 1.2) +
    geom_segment(data = a2, aes(
      x = x, #-0.15, 
      y = y, #-0.1*r2 + 0.1807896*2, 
      xend = xend, #-0.15, 
      yend = yend), #-0.1*r2 + 0.1807896*3),
      arrow = arrow(length = unit(0.03, "npc"),
                               ends = "both"), 
      color = "black") + # a2 = 0.1807896
    annotate("text", x=a2$x, y=(a2$y+a2$yend)/2, 
             label = expression(a[2]), 
             color = "black", hjust=-0.2) +
    annotate("text", x=-0.18, y=-0.24, 
      label = expression(group("(", list(s[1], s[2]), ")")),
      color = "black") +
  geom_segment(data = l, aes(
      x = x, #-0.15, 
      y = y, #-0.1*r2 + 0.1807896*2, 
      xend = xend, #-0.15, 
      yend = yend), #-0.1*r2 + 0.1807896*3),
      arrow = arrow(length = unit(0.03, "npc"),
                               ends = "both"), 
      color = "black") + 
    annotate("text", x=l$x + 0.03, y=(l$y+l$yend)/2, 
             label = expression(l), 
             color = "black", hjust=-0.2) +
  coord_equal()


## -----------------------------------------------------------------------------
#| label: fig-hex-param
#| fig-cap: "The components of the hexagon grid illustrating notation."

hex_param_vis


## ----echo=TRUE----------------------------------------------------------------
df_bin_centroids <- extract_hexbin_centroids(
  centroids_data = hb_obj$centroids, 
  counts_data = hb_obj$std_cts
  )

df_bin_centroids


## ----echo=TRUE----------------------------------------------------------------
tr_object <- tri_bin_centroids(
  centroids_data = df_bin_centroids
  )

trimesh <- gen_edges(tri_object = tr_object, a1 = hb_obj$a1)
trimesh


## ----echo=TRUE----------------------------------------------------------------
find_low_dens_hex(
  centroids_data = df_bin_centroids, 
  bin1 = 15, 
  benchmark_mean_dens = 0.05
)



## ----echo=TRUE----------------------------------------------------------------
df_bin <- avg_highd_data(
  highd_data = scurve, 
  scaled_nldr_hexid = hb_obj$data_hb_id
)

df_bin


## ----echo=TRUE----------------------------------------------------------------
predict_emb(
  highd_data = scurve, 
  model_2d = df_bin_centroids, 
  model_highd = df_bin
  )


## ----echo=TRUE----------------------------------------------------------------
glance(
  highd_data = scurve, 
  model_2d = df_bin_centroids, 
  model_highd = df_bin
  )


## ----echo=TRUE----------------------------------------------------------------
model_error <- augment(
  highd_data = scurve, 
  model_2d = df_bin_centroids, 
  model_highd = df_bin
  )

model_error


## ----echo=TRUE----------------------------------------------------------------
ggplot() + 
  geom_hexgrid(
    data = hb_obj$centroids, 
    aes(x = c_x, y = c_y)
    ) 


## ----echo=TRUE----------------------------------------------------------------
ggplot() + 
  geom_trimesh(
    data = hb_obj$centroids, 
    aes(x = c_x, y = c_y)
    ) 


## ----echo=TRUE----------------------------------------------------------------
vis_mesh(
  trimesh_data = trimesh
  )


## ----echo=TRUE----------------------------------------------------------------
df_bin_centroids <- df_bin_centroids |>
  dplyr::filter(bin_counts > 10)

df_exe <- comb_data_model(
  highd_data = scurve, 
  model_highd = df_bin, 
  model_2d = df_bin_centroids
  )

df_exe


## ----echo=TRUE, eval=knitr::is_html_output()----------------------------------
# trimesh <- trimesh |>
#   dplyr::filter(from_count > 10,
#                 to_count > 10)
# 
# trimesh <- update_trimesh_index(trimesh)
# 
# show_langevitour(
#   point_data = df_exe,
#   edge_data = trimesh
#   )


## ----echo=TRUE----------------------------------------------------------------
df_exe <- comb_all_data_model(
  highd_data = scurve, 
  nldr_data = scurve_umap, 
  model_highd = df_bin, 
  model_2d = df_bin_centroids
  )


## ----echo=TRUE, eval=knitr::is_html_output()----------------------------------
# show_link_plots(
#   point_data = df_exe,
#   edge_data = trimesh
#   )


## ----echo=TRUE----------------------------------------------------------------
df_exe <- comb_all_data_model_error(
  highd_data = scurve, 
  nldr_data = scurve_umap, 
  model_highd = df_bin, 
  model_2d = df_bin_centroids, 
  error_data = model_error
  )


## ----echo=TRUE, eval=knitr::is_html_output()----------------------------------
# show_error_link_plots(
#   point_data = df_exe,
#   edge_data = trimesh
#   )


## -----------------------------------------------------------------------------
#| label: read-limb-nldr
# Read a variety of different NLDR representations of limb
# and plot them on same aspect ratio
clr_choice <- "#0077A3"
umap_limb <- read_rds("data/limb_muscles/facs_limb_muscles_umap_n-neigbors_15_min-dist_0.1.rds")

nldr1 <- umap_limb |>
  ggplot(aes(x = emb1,
             y = emb2)) +
  geom_point(alpha=0.1, size=1, colour='#999999') +
  interior_annotation("a")

tsne_limb <- read_rds("data/limb_muscles/facs_limb_muscles_tsne_perplexity_30.rds")

nldr2 <- tsne_limb |>
  ggplot(aes(x = emb1,
             y = emb2)) +
  geom_point(alpha=0.1, size=1, colour='#a65628') +
  interior_annotation("b")

phate_limb <- read_rds("data/limb_muscles/facs_limb_muscles_phate_knn_5.rds")

nldr3 <- phate_limb |>
  ggplot(aes(x = emb1,
             y = emb2)) +
  geom_point(alpha=0.1, size=1, colour='#e41a1c') +
  interior_annotation("c")

trimap_limb <- read_rds("data/limb_muscles/facs_limb_muscles_trimap_n-inliers_12_n-outliers_4_n-random_3.rds")

nldr4 <- trimap_limb |>
  ggplot(aes(x = emb1,
             y = emb2)) +
  geom_point(alpha=0.1, size=1, colour='#377eb8') +
  interior_annotation("d")

pacmap_limb <- read_rds("data/limb_muscles/facs_limb_muscles_pacmap_n-neighbors_10_init_random_MN-ratio_0.5_FP-ratio_2.rds")

nldr5 <- pacmap_limb |>
  ggplot(aes(x = emb1,
             y = emb2)) +
  geom_point(alpha=0.1, size=1, colour='#4daf4a') +
  interior_annotation("e")

tsne_limb2 <- read_rds("data/limb_muscles/facs_limb_muscles_tsne_perplexity_15.rds")

nldr6 <- tsne_limb2 |>
  ggplot(aes(x = emb1,
             y = emb2)) +
  geom_point(alpha=0.1, size=1, colour='#ff7f00') +
  interior_annotation("f")


## -----------------------------------------------------------------------------
#| label: combine-error-data-muscles

error_limb_umap <- read_rds("data/limb_muscles/error_limb_muscles_umap_n-neigbors_15_min-dist_0.1.rds")
error_limb_tsne <- read_rds("data/limb_muscles/error_limb_muscles_tsne_perplexity_30.rds")
error_limb_phate <- read_rds("data/limb_muscles/error_limb_muscles_phate_knn_5.rds")
error_limb_trimap <- read_rds("data/limb_muscles/error_limb_muscles_trimap_n-inliers_12_n-outliers_4_n-random_3.rds")
error_limb_pacmap <- read_rds("data/limb_muscles/error_limb_muscles_pacmap_n-neighbors_10_init_random_MN-ratio_0.5_FP-ratio_2.rds")

error_limb_tsne2 <- read_rds("data/limb_muscles/error_limb_muscles_tsne_perplexity_15.rds")

error_limb <- bind_rows(error_limb_umap, 
                        error_limb_tsne,
                        error_limb_phate,
                        error_limb_trimap,
                        error_limb_pacmap,
                        error_limb_tsne2)

error_limb <- error_limb |>
  mutate(a1 = round(a1, 2)) |>
  filter(bin1 >= 5) |>
  filter(a1 >= 0.03) |>
  group_by(method, a1) |>
  filter(MSE == min(MSE)) |>
  ungroup()

error_limb <- error_limb |>
  mutate(method = factor(method,
                         levels = c("UMAP_15_min_dist_0.1","tsne_30", "phate_5", "trimap_n-inliers_12_n-outliers_4_n-random_3", "pacmap_n-neighbors_10_init_random_MN-ratio_0.5_FP-ratio_2", "tsne_15")))


## -----------------------------------------------------------------------------
#| label: error-comp-muscles

error_plot_limb <- plot_mse(error_limb) +
  scale_x_continuous(breaks = sort(unique(error_limb$a1))[c(1, 5, 9, 13, 17, 21, 26)]) +
  scale_color_manual(values=c('#999999','#a65628','#e41a1c','#377eb8','#4daf4a','#ff7f00','#984ea3','#f781bf')) 



## -----------------------------------------------------------------------------
#| fig-cap: ""
#| label: fig-limb-mse
#| out-width: 100%

free(error_plot_limb) + wrap_plots(
  nldr1, nldr2, nldr3, 
  nldr4, nldr5, nldr6, ncol = 2)


## -----------------------------------------------------------------------------
#| label: data-limb

training_data_limb <- read_rds("data/limb_muscles/facs_limb_muscles_pcs_10.rds")

cluster_df <- read_rds("data/limb_muscles/facs_limb_muscles_cluster_df.rds")


## -----------------------------------------------------------------------------
#| label: tsne-num-bins-limb
#| eval: false

# ## Compute hexbin parameters
# num_bins_x_limb <- 19
# 
# algo_obj_limb <- gen_nldr_vis_algo_obj(
#   high_d_data = training_data_limb,
#   nldr_data = tsne_limb,
#   num_x_bins = num_bins_x_limb)
# 
# tsne_limb_scaled <- algo_obj_limb$nldr_scaled
# distance_limb <- algo_obj_limb$distance_df
# tr_from_to_df_limb <- algo_obj_limb$tr_from_to_df
# benchmark_limb <- algo_obj_limb$benchmark
# df_bin_centroids_limb <- algo_obj_limb$df_bin_centroids
# df_bin_limb <- algo_obj_limb$df_bin
# 
# distance_df_small_edges_limb <- distance_limb |>
#   filter(distance < 0.1) #benchmark_limb
# 
# tr_from_to_df_limb <- right_join(
#   tr_from_to_df_limb, distance_df_small_edges_limb,
#   by = c("from", "to"))
# 
# tsne_limb_scaled_with_cluster <- inner_join(tsne_limb_scaled, cluster_df, by = "ID") |>
#   mutate(cluster.ids = as.character(cluster.ids))
# 
# trimesh_removed_limb <- ggplot() +
#   geom_point(
#     data = tsne_limb_scaled_with_cluster,
#     aes(
#       x = emb1,
#       y = emb2,
#       color = cluster.ids
#     ),
#     alpha = 0.3#,
#     #color = "#a65628"
#   ) +
#     geom_segment(data = tr_from_to_df_limb,
#                aes(
#                  x = x_from,
#                  y = y_from,
#                  xend = x_to,
#                  yend = y_to),
#                colour = "#000000",
#                linewidth = 1) +
#   scale_color_manual(values = c('#66c2a5','#fc8d62','#8da0cb','#e78ac3','#a6d854','#ffd92f','#e5c494')) +
#   interior_annotation("a1", cex = 2) +
#   theme(
#     aspect.ratio = 1
#   )


## -----------------------------------------------------------------------------
#| label: prep-limb-tsne-author-model-proj
#| eval: false

# data_limb <- training_data_limb |>
#   select(-ID) |>
#   mutate(type = "data")
# 
# df_b_limb <- df_bin_limb |>
#   dplyr::filter(hb_id %in% df_bin_centroids_limb$hexID) |>
#   dplyr::mutate(type = "model") ## Data with summarized mean
# 
# ## Reorder the rows of df_b according to the hexID order in df_b_with_center_data
# df_b_limb <- df_b_limb[match(df_bin_centroids_limb$hexID, df_b_limb$hb_id),] |>
#   dplyr::select(-hb_id)
# 
# # Apply the scaling
# df_model_data_limb <- bind_rows(data_limb, df_b_limb)
# scaled_limb <- scale_data_manual(df_model_data_limb, "type") |>
#   as_tibble()
# 
# scaled_limb_data <- scaled_limb |>
#   filter(type == "data") |>
#   select(-type)
# 
# scaled_limb_data_model <- scaled_limb |>
#   filter(type == "model") |>
#   select(-type)


## -----------------------------------------------------------------------------
#| label: langevitour-limb-tsne-author-proj
#| eval: false

# data_limb_n <- data_limb |>
#   select(-type) |>
#   mutate(type = as.character(tsne_limb_scaled_with_cluster$cluster.ids))
# 
# df_model_data_limb_n <- bind_rows(df_b_limb, data_limb_n)
# 
# langevitour::langevitour(df_model_data_limb_n[1:(length(df_model_data_limb_n)-1)],
#                          lineFrom = distance_df_small_edges_limb$from,
#                          lineTo = distance_df_small_edges_limb$to,
#                          group = factor(df_model_data_limb_n$type,
#                                         c("0", "1", "2", "3", "4", "5", "6", "model")),
#                          levelColors = c('#66c2a5','#fc8d62','#8da0cb','#e78ac3','#a6d854','#ffd92f','#e5c494', "#000000"))


## -----------------------------------------------------------------------------
#| label: tsne-best-num-bins-limb
#| eval: false

# ## Compute hexbin parameters
# num_bins_x_limb <- 18
# 
# algo_obj_limb <- gen_nldr_vis_algo_obj(
#   high_d_data = training_data_limb,
#   nldr_data = tsne_limb2,
#   num_x_bins = num_bins_x_limb)
# 
# tsne_limb_scaled_best <- algo_obj_limb$nldr_scaled
# distance_limb <- algo_obj_limb$distance_df
# tr_from_to_df_limb <- algo_obj_limb$tr_from_to_df
# benchmark_limb <- algo_obj_limb$benchmark
# df_bin_centroids_limb <- algo_obj_limb$df_bin_centroids
# df_bin_limb <- algo_obj_limb$df_bin
# 
# distance_df_small_edges_limb <- distance_limb |>
#   filter(distance < benchmark_limb) #benchmark_limb
# 
# tr_from_to_df_limb <- right_join(
#   tr_from_to_df_limb, distance_df_small_edges_limb,
#   by = c("from", "to"))
# 
# tsne_limb_scaled_best_with_cluster <- inner_join(tsne_limb_scaled_best, cluster_df, by = "ID") |>
#   mutate(cluster.ids = as.character(cluster.ids))
# 
# 
# trimesh_removed_limb_best <- ggplot() +
#   geom_point(
#     data = tsne_limb_scaled_best_with_cluster,
#     aes(
#       x = emb1,
#       y = emb2,
#       color = cluster.ids
#     ),
#     alpha = 0.3#,
#     #color = "#ff7f00"
#   ) +
#     geom_segment(data = tr_from_to_df_limb,
#                aes(
#                  x = x_from,
#                  y = y_from,
#                  xend = x_to,
#                  yend = y_to),
#                colour = "#000000",
#                linewidth = 1) +
#   scale_color_manual(values = c('#66c2a5','#fc8d62','#8da0cb','#e78ac3','#a6d854','#ffd92f','#e5c494')) +
#   interior_annotation("b1", cex = 2) +
#   theme(
#     aspect.ratio = 1
#   )


## -----------------------------------------------------------------------------
#| label: prep-limb-tsne-best-model-proj
#| eval: false

# data_limb <- training_data_limb |>
#   select(-ID) |>
#   mutate(type = "data")
# 
# df_b_limb <- df_bin_limb |>
#   dplyr::filter(hb_id %in% df_bin_centroids_limb$hexID) |>
#   dplyr::mutate(type = "model") ## Data with summarized mean
# 
# ## Reorder the rows of df_b according to the hexID order in df_b_with_center_data
# df_b_limb <- df_b_limb[match(df_bin_centroids_limb$hexID, df_b_limb$hb_id),] |>
#   dplyr::select(-hb_id)
# 
# # Apply the scaling
# df_model_data_limb <- bind_rows(data_limb, df_b_limb)
# scaled_limb <- scale_data_manual(df_model_data_limb, "type") |>
#   as_tibble()
# 
# scaled_limb_data <- scaled_limb |>
#   filter(type == "data") |>
#   select(-type)
# 
# scaled_limb_data_model <- scaled_limb |>
#   filter(type == "model") |>
#   select(-type)


## -----------------------------------------------------------------------------
#| label: langevitour-limb-tsne-best-proj
#| eval: false

# df_model_data_limb_n <- bind_rows(df_b_limb, data_limb_n)
# 
# langevitour::langevitour(df_model_data_limb_n[1:(length(df_model_data_limb_n)-1)],
#                          lineFrom = distance_df_small_edges_limb$from,
#                          lineTo = distance_df_small_edges_limb$to,
#                          group = factor(df_model_data_limb_n$type,
#                                         c("0", "1", "2", "3", "4", "5", "6", "model")),
#                          levelColors = c('#66c2a5','#fc8d62','#8da0cb','#e78ac3','#a6d854','#ffd92f','#e5c494', "#000000"))


## -----------------------------------------------------------------------------
#| eval: false
# trimesh_removed_limb + trimesh_removed_limb_best +
#   plot_layout(ncol = 3)

