# Generated by `rjournal_pdf_article()` using `knitr::purl()`: do not edit by hand
# Please edit paper-quollr.Rmd to modify this file

## ----setup, include=FALSE-----------------------------------------------------
options(repos = "https://cloud.r-project.org") ## set up CRAN mirror
knitr::opts_chunk$set(
  echo = FALSE, 
  cache=FALSE, 
  message=FALSE, 
  warning=FALSE,
  out.width = "100%")



## ----load-libraries-----------------------------------------------------------
library(quollr)
library(tibble)
library(knitr)
library(kableExtra)
library(ggplot2)
library(dplyr)
library(ggbeeswarm)
library(patchwork)
library(Rtsne)
library(uwot)
library(readr)
library(tools)
library(cardinalR)

set.seed(20240110)


## ----plot-theme---------------------------------------------------------------
theme_set(theme_linedraw() +
   theme(
     aspect.ratio = 1,
     plot.background = element_rect(fill = 'transparent', colour = NA),
     plot.title = element_text(size = 7, hjust = 0.5, vjust = -0.5),
     panel.background = element_rect(fill = 'transparent', 
                                     colour = NA),
     panel.grid.major = element_blank(), 
     panel.grid.minor = element_blank(), 
     axis.title.x = element_blank(), axis.title.y = element_blank(),
     axis.text.x = element_blank(), axis.ticks.x = element_blank(),
     axis.text.y = element_blank(), axis.ticks.y = element_blank(),
     legend.background = element_rect(fill = 'transparent', 
                                      colour = NA),
     legend.key = element_rect(fill = 'transparent', 
                               colour = NA),
     legend.position = "none", 
     legend.title = element_text(size=5), 
     legend.text = element_text(size=4),
     legend.key.height = unit(0.25, 'cm'),
     legend.key.width = unit(0.25, 'cm')
   )

)

interior_annotation <- function(label, position = c(0.92, 0.92)) {
  annotation_custom(grid::textGrob(label = label,
      x = unit(position[1], "npc"), y = unit(position[2], "npc"),
      gp = grid::gpar(cex = 1, col="grey70")))
}


## -----------------------------------------------------------------------------
package_dependencies("quollr")


## ----echo=TRUE----------------------------------------------------------------
scaled_nldr_obj_scurve <- gen_scaled_data(data = s_curve_noise_umap)

s_curve_noise_umap_scaled <- scaled_nldr_obj_scurve$scaled_nldr

lim1 <- scaled_nldr_obj_scurve$lim1
lim2 <- scaled_nldr_obj_scurve$lim2
r2 <- diff(lim2)/diff(lim1) 


## ----echo=TRUE----------------------------------------------------------------
fit_highd_model(
  training_data = s_curve_noise_training,
  emb_df = s_curve_noise_umap_scaled, 
  bin1 = 12, 
  r2 = r2,
  q = 0.07,
  is_bin_centroid = TRUE,
  is_rm_lwd_hex = TRUE,
  benchmark_to_rm_lwd_hex = NULL,
  col_start_highd = "x"
  )


## ----echo=TRUE----------------------------------------------------------------
calc_bins_y(
  bin1 = 12, 
  r2 = r2,
  q = 0.07
  )


## ----echo=TRUE----------------------------------------------------------------
hex_binning(
  data = s_curve_noise_umap_scaled, 
  bin1 = 12, 
  r2 = r2,
  q = 0.07
  )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> find_low_dens_hex(
#>   df_bin_centroids_all = df_bin_centroids,
#>   bin1 = 12,
#>   df_bin_centroids_low = df_bin_centroids_low
#>   )
#> 


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> tr1_object <- tri_bin_centroids(
#>   hex_df = df_bin_centroids,
#>   x = "c_x",
#>   y = "c_y"
#>   )
#> 
#> tr_from_to_df <- gen_edges(
#>   tri_object = tr1_object
#>   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> find_lg_benchmark(
#>   distance_edges = distance_df,
#>   distance_col = "distance"
#>   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> umap_data_with_hb_id <- hb_obj$data_hb_id
#> 
#> df_all <- bind_cols(
#>   s_curve_noise_training |> dplyr::select(-ID),
#>   umap_data_with_hb_id
#>   )
#> 
#> df_bin <- avg_highd_data(
#>   data = df_all,
#>   col_start = "x"
#>   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> predict_emb(
#>   test_data = s_curve_noise_training,
#>   df_bin_centroids = df_bin_centroids,
#>   df_bin = df_bin,
#>   type_NLDR = "UMAP"
#>   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> glance(
#>   df_bin_centroids = df_bin_centroids,
#>   df_bin = df_bin,
#>   training_data = s_curve_noise_training,
#>   newdata = NULL,
#>   type_NLDR = "UMAP",
#>   col_start = "x"
#>   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> augment(
#>   df_bin_centroids = df_bin_centroids,
#>   df_bin = df_bin,
#>   training_data = s_curve_noise_training,
#>   newdata = NULL,
#>   type_NLDR = "UMAP",
#>   col_start = "x"
#>   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> ggplot() +
#>   geom_hexgrid(
#>     data = all_centroids_df,
#>     aes(x = c_x, y = c_y)
#>     ) +
#>   coord_fixed()


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> ggplot() +
#>   geom_trimesh(
#>     data = df_bin_centroids,
#>     aes(x = c_x, y = c_y)
#>     ) +
#>   coord_fixed()


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> vis_lg_mesh(
#>   distance_edges = distance_df,
#>   benchmark_value = 0.75,
#>   tr_coord_df = tr_from_to_df,
#>   distance_col = "distance"
#>   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> vis_rmlg_mesh(
#>   distance_edges = distance_df,
#>   benchmark_value = 0.75,
#>   tr_coord_df = tr_from_to_df,
#>   distance_col = "distance"
#>   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
#> show_langevitour(
#>   df = df_all,
#>   df_b = df_bin,
#>   df_b_with_center_data = df_bin_centroids,
#>   benchmark_value = 0.75,
#>   distance = distance_df,
#>   distance_col = "distance",
#>   use_default_benchmark_val = FALSE,
#>   col_start = "x"
#>   )


## -----------------------------------------------------------------------------
triangular_3d_data <- tri_3d(
  n = 1250, num_noise = 2, 
  min_n = -0.05, max_n = 0.05) |>
  as_tibble() 

colnames(triangular_3d_data) <- paste0("x", 1:NCOL(triangular_3d_data))
  
#langevitour::langevitour(triangular_3d_data)


## -----------------------------------------------------------------------------
triangular_3d_data <- triangular_3d_data |>
  mutate(ID = row_number())


## -----------------------------------------------------------------------------
sc_ltr_pos <- c(0.08, 0.96)


## -----------------------------------------------------------------------------
tSNE_fit1 <- triangular_3d_data |>
  select(-ID) |>
  Rtsne(perplexity = 6) 

tsne_prism1 <- tSNE_fit1$Y |>
  as_tibble() |>
  mutate(ID = row_number())

colnames(tsne_prism1) <- c("tSNE1", "tSNE2", "ID")

prism_scaled_obj_tsne1 <- gen_scaled_data(
  data = tsne_prism1)
tsne_prism_scaled1 <- prism_scaled_obj_tsne1$scaled_nldr

nldr_prism1 <- tsne_prism_scaled1 |> 
  ggplot(aes(x = tSNE1, y = tSNE2)) + 
  geom_point(alpha=0.5, colour="#000000", size = 0.5) 


## -----------------------------------------------------------------------------
tSNE_fit2 <- triangular_3d_data |>
  select(-ID) |>
  Rtsne(perplexity = round(sqrt(NROW(triangular_3d_data)))) 

tsne_prism2 <- tSNE_fit2$Y |>
  as_tibble() |>
  mutate(ID = row_number())

colnames(tsne_prism2) <- c("tSNE1", "tSNE2", "ID")

prism_scaled_obj_tsne2 <- gen_scaled_data(
  data = tsne_prism2)
tsne_prism_scaled2 <- prism_scaled_obj_tsne2$scaled_nldr

nldr_prism2 <- tsne_prism_scaled2 |> 
  ggplot(aes(x = tSNE1, y = tSNE2)) + 
  geom_point(alpha=0.5, colour="#000000", size = 0.5) 


## -----------------------------------------------------------------------------
tSNE_fit3 <- triangular_3d_data |>
  select(-ID) |>
  Rtsne(perplexity = 58) 

tsne_prism3 <- tSNE_fit3$Y |>
  as_tibble() |>
  mutate(ID = row_number())

colnames(tsne_prism3) <- c("tSNE1", "tSNE2", "ID")

prism_scaled_obj_tsne3 <- gen_scaled_data(
  data = tsne_prism3)
tsne_prism_scaled3 <- prism_scaled_obj_tsne3$scaled_nldr

nldr_prism3 <- tsne_prism_scaled3 |> 
  ggplot(aes(x = tSNE1, y = tSNE2)) + 
  geom_point(alpha=0.5, colour="#000000", size = 0.5) 


## -----------------------------------------------------------------------------
umap_prism1 <- triangular_3d_data |>
  select(-ID) |>
  umap(n_neighbors = 15, n_components =  2, 
       metric = "euclidean", min_dist = 0.3, init = "spca")

umap_prism1 <- umap_prism1 |>
  as_tibble()

names(umap_prism1) <- c("UMAP1", "UMAP2")

umap_prism1 <- umap_prism1 |>
  mutate(ID = 1:NROW(umap_prism1))

prism_scaled_obj_umap1 <- gen_scaled_data(
  data = umap_prism1)
umap_prism_scaled1 <- prism_scaled_obj_umap1$scaled_nldr

nldr_prism4 <- umap_prism_scaled1 |> 
  ggplot(aes(x = UMAP1, y = UMAP2)) + 
  geom_point(alpha=0.5, colour="#000000", size = 0.5) 


## -----------------------------------------------------------------------------
umap_prism2 <- triangular_3d_data |>
  select(-ID) |>
  umap(n_neighbors = 35, n_components =  2, 
       metric = "euclidean", min_dist = 0.5, init = "spca")

umap_prism2 <- umap_prism2 |>
  as_tibble()

names(umap_prism2) <- c("UMAP1", "UMAP2")

umap_prism2 <- umap_prism2 |>
  mutate(ID = 1:NROW(umap_prism2))

prism_scaled_obj_umap2 <- gen_scaled_data(
  data = umap_prism2)
umap_prism_scaled2 <- prism_scaled_obj_umap2$scaled_nldr

nldr_prism5 <- umap_prism_scaled2 |> 
  ggplot(aes(x = UMAP1, y = UMAP2)) + 
  geom_point(alpha=0.5, colour="#000000", size = 0.5) 


## -----------------------------------------------------------------------------
umap_prism3 <- triangular_3d_data |>
  select(-ID) |>
  umap(n_neighbors = 69, n_components =  2, 
       metric = "euclidean", min_dist = 0.6, init = "spca")

umap_prism3 <- umap_prism3 |>
  as_tibble()

names(umap_prism3) <- c("UMAP1", "UMAP2")

umap_prism3 <- umap_prism3 |>
  mutate(ID = 1:NROW(umap_prism3))

prism_scaled_obj_umap3 <- gen_scaled_data(
  data = umap_prism3)
umap_prism_scaled3 <- prism_scaled_obj_umap3$scaled_nldr

nldr_prism6 <- umap_prism_scaled3 |> 
  ggplot(aes(x = UMAP1, y = UMAP2)) + 
  geom_point(alpha=0.5, colour="#000000", size = 0.5) 


## -----------------------------------------------------------------------------
nldr_prism1 + nldr_prism2 + nldr_prism3 + 
  nldr_prism4 + nldr_prism5 + nldr_prism6 +
  plot_layout(ncol=3)


## -----------------------------------------------------------------------------
error_prism_tsne <- data.frame(matrix(nrow = 0, ncol = 0))

## To initialize number of bins along the x-axis
bin1_vec_prism <- 2:25 

perplexity_vec <- c(6, 35, 58)

for (perplexity_val in perplexity_vec) {
  
  tSNE_fit <- triangular_3d_data |>
    select(-ID) |>
    Rtsne(perplexity = perplexity_val)
  
  tsne_prism <- tSNE_fit$Y |>
    as_tibble() |>
    mutate(ID = row_number())
  
  colnames(tsne_prism) <- c("tSNE1", "tSNE2", "ID")
  
  prism_scaled_obj <- gen_scaled_data(
    data = tsne_prism)
  tsne_prism_scaled <- prism_scaled_obj$scaled_nldr
  
  lim1 <- prism_scaled_obj$lim1
  lim2 <- prism_scaled_obj$lim2
  r2_prism <- diff(lim2)/diff(lim1) 
  
  for (xbins in bin1_vec_prism) {
    
    bin2 <- calc_bins_y(bin1 = xbins, r2 = r2_prism)$bin2
    
    prism_model <- fit_highd_model(
      training_data = triangular_3d_data,
      emb_df = tsne_prism_scaled,
      bin1 = xbins,
      r2 = r2_prism,
      is_bin_centroid = TRUE,
      is_rm_lwd_hex = TRUE,
      col_start_highd = "x"
    )
    
    df_bin_centroids_prism <- prism_model$df_bin_centroids
    df_bin_prism <- prism_model$df_bin
    
    ## Compute error
    error_df <- glance(
      df_bin_centroids = df_bin_centroids_prism,
      df_bin = df_bin_prism,
      training_data = triangular_3d_data,
      newdata = NULL,
      type_NLDR = "tSNE",
      col_start = "x") |>
      mutate(bin1 = xbins,
             bin2 = bin2,
             b = bin1 * bin2,
             b_non_empty = NROW(df_bin_centroids_prism),
             type = paste0("perplexity: ", perplexity_val))
    
    error_prism_tsne <- bind_rows(error_prism_tsne, error_df)
    
  }
  
}


## -----------------------------------------------------------------------------
error_prism_umap <- data.frame(matrix(nrow = 0, ncol = 0))

## To initialize number of bins along the x-axis
bin1_vec_prism <- 2:25 

param_list <- list(param1 = c(15, 0.3), param2 = c(35, 0.5), param3 = c(69, 0.6))

for (i in 1:length(param_list)) {
  
  n_neighbors_val <- param_list[[i]][1]
  min_dist_val <- param_list[[i]][2]
    
  umap_prism <- triangular_3d_data |>
    select(-ID) |>
    umap(n_neighbors = n_neighbors_val, n_components =  2, 
         metric = "euclidean", min_dist = min_dist_val, init = "spca")

  umap_prism <- umap_prism |>
    as_tibble()
  
  names(umap_prism) <- c("UMAP1", "UMAP2")
  
  umap_prism <- umap_prism |>
    mutate(ID = 1:NROW(umap_prism))
  
  prism_scaled_obj <- gen_scaled_data(
    data = umap_prism)
  umap_prism_scaled <- prism_scaled_obj$scaled_nldr
  
  lim1 <- prism_scaled_obj$lim1
  lim2 <- prism_scaled_obj$lim2
  r2_prism <- diff(lim2)/diff(lim1) 
  
  for (xbins in bin1_vec_prism) {
    
    bin2 <- calc_bins_y(bin1 = xbins, r2 = r2_prism)$bin2
    
    prism_model <- fit_highd_model(
      training_data = triangular_3d_data,
      emb_df = umap_prism_scaled,
      bin1 = xbins,
      r2 = r2_prism,
      is_bin_centroid = TRUE,
      is_rm_lwd_hex = TRUE,
      col_start_highd = "x"
    )
    
    df_bin_centroids_prism <- prism_model$df_bin_centroids
    df_bin_prism <- prism_model$df_bin
    
    ## Compute error
    error_df <- glance(
      df_bin_centroids = df_bin_centroids_prism,
      df_bin = df_bin_prism,
      training_data = triangular_3d_data,
      newdata = NULL,
      type_NLDR = "UMAP",
      col_start = "x") |>
      mutate(bin1 = xbins,
             bin2 = bin2,
             b = bin1 * bin2,
             b_non_empty = NROW(df_bin_centroids_prism),
             type = paste0("n_neighbors: ", n_neighbors_val, 
                           " min_dist: ", min_dist_val))
    
    error_prism_umap <- bind_rows(error_prism_umap, error_df)
    
  }
  
}


## -----------------------------------------------------------------------------
error_prism <- bind_rows(error_prism_tsne, error_prism_umap) 
error_prism <- error_prism |>
  filter(b <= 625)


## -----------------------------------------------------------------------------
error_plot_prism <- ggplot(error_prism, 
                           aes(x = b_non_empty, 
                               y = log(Error), 
                               group = type, 
                               colour = type)) + 
  geom_point(size = 1) +
  geom_line() + 
  geom_vline(xintercept = 112, linetype="solid",
             color = "black", linewidth=0.8, alpha = 0.5) +
  scale_color_manual(values=c('#e41a1c','#377eb8','#4daf4a','#984ea3',
                              '#ff7f00','#a6cee3','#a65628','#f781bf')) +
  ylab("log(Error)") +
  xlab("number of non-empty bins") +
  theme(axis.text.x = element_text(size = 5),
        axis.text.y = element_text(size = 5),
        axis.title.x = element_text(size = 5),
        axis.title.y = element_text(size = 5, angle = 90),
        legend.position = "bottom")

error_plot_prism


## -----------------------------------------------------------------------------
## Compute hexbin parameters
num_bins_x_prism <- 21
lim1 <- prism_scaled_obj_tsne2$lim1
lim2 <- prism_scaled_obj_tsne2$lim2
r2_prism <- diff(lim2)/diff(lim1) 

prism_model <- fit_highd_model(
  training_data = triangular_3d_data,
  emb_df = tsne_prism_scaled2,
  bin1 = num_bins_x_prism,
  r2 = r2_prism,
  is_bin_centroid = TRUE,
  is_rm_lwd_hex = TRUE,
  col_start_highd = "x"
)

df_bin_centroids_prism <- prism_model$df_bin_centroids
df_bin_prism <- prism_model$df_bin

## Triangulate bin centroids
tr1_object_prism <- tri_bin_centroids(
  df_bin_centroids_prism, x = "c_x", y = "c_y")
tr_from_to_df_prism <- gen_edges(
  tri_object = tr1_object_prism)

## Compute 2D distances
distance_prism <- cal_2d_dist(
  tr_coord_df = tr_from_to_df_prism,
  start_x = "x_from",
  start_y = "y_from",
  end_x = "x_to",
  end_y = "y_to",
  select_vars = c("from", "to", "distance"))

## To find the benchmark value
benchmark_prism <- find_lg_benchmark(
  distance_edges = distance_prism,
  distance_col = "distance")

trimesh_removed_prism <- vis_rmlg_mesh(
  distance_edges = distance_prism,
  benchmark_value = benchmark_prism,
  tr_coord_df = tr_from_to_df_prism,
  distance_col = "distance") #+
#xlim(sc_xlims) + ylim(sc_ylims) +
#interior_annotation("a", sc_ltr_pos)

trimesh_removed_prism


## -----------------------------------------------------------------------------
## Hexagonal binning to have regular hexagons
hb_obj_prism <- hex_binning(
  data = tsne_prism_scaled2,
  bin1 = num_bins_x_prism,
  r2 = r2_prism)

tsne_data_with_hb_id <- hb_obj_prism$data_hb_id

df_all_prism <- dplyr::bind_cols(triangular_3d_data |> dplyr::select(-ID),
                                 tsne_data_with_hb_id)

### Define type column
df <- df_all_prism |>
  dplyr::select(tidyselect::starts_with("x")) |>
  dplyr::mutate(type = "data") ## original dataset

df_b <- df_bin_prism |>
  dplyr::filter(hb_id %in% df_bin_centroids_prism$hexID) |>
  dplyr::mutate(type = "model") ## Data with summarized mean

## Reorder the rows of df_b according to the hexID order in df_b_with_center_data
df_b <- df_b[match(df_bin_centroids_prism$hexID, df_b$hb_id),] |>
  dplyr::select(-hb_id)

df_exe <- dplyr::bind_rows(df_b, df)

## Set the maximum difference as the criteria
distance_df_small_edges <- distance_prism |>
  dplyr::filter(distance < benchmark_prism)
## Since erase brushing is considerd.

# langevitour::langevitour(df_exe[1:(length(df_exe)-1)],
#                          lineFrom = distance_df_small_edges$from,
#                          lineTo = distance_df_small_edges$to,
#                          group = df_exe$type, pointSize = append(rep(0, NROW(df_b)), rep(0.8, NROW(df))),
#                          levelColors = c("#6a3d9a", "#33a02c"))

