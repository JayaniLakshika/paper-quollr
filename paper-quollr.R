# Generated by `rjournal_pdf_article()` using `knitr::purl()`: do not edit by hand
# Please edit paper-quollr.Rmd to modify this file

## ----setup, include=FALSE-----------------------------------------------------
options(repos = "https://cloud.r-project.org") ## set up CRAN mirror
knitr::opts_chunk$set(
  echo = FALSE, 
  cache=FALSE, 
  message=FALSE, 
  warning=FALSE,
  out.width = "100%")



## ----load-libraries-----------------------------------------------------------
library(quollr)
library(tibble)
library(knitr)
library(kableExtra)
library(ggplot2)
library(dplyr)
library(ggbeeswarm)
library(patchwork)
library(Rtsne)
library(uwot)
library(readr)
library(tools)
library(cardinalR)

set.seed(20240110)


## ----plot-theme---------------------------------------------------------------
theme_set(theme_linedraw() +
   theme(
     aspect.ratio = 1,
     plot.background = element_rect(fill = 'transparent', colour = NA),
     plot.title = element_text(size = 7, hjust = 0.5, vjust = -0.5),
     panel.background = element_rect(fill = 'transparent', 
                                     colour = NA),
     panel.grid.major = element_blank(), 
     panel.grid.minor = element_blank(), 
     axis.title.x = element_blank(), axis.title.y = element_blank(),
     axis.text.x = element_blank(), axis.ticks.x = element_blank(),
     axis.text.y = element_blank(), axis.ticks.y = element_blank(),
     legend.background = element_rect(fill = 'transparent', 
                                      colour = NA),
     legend.key = element_rect(fill = 'transparent', 
                               colour = NA),
     legend.position = "none", 
     legend.title = element_text(size=5), 
     legend.text = element_text(size=4),
     legend.key.height = unit(0.25, 'cm'),
     legend.key.width = unit(0.25, 'cm')
   )

)


## -----------------------------------------------------------------------------
#| label: import-scripts
source("scripts/additional_functions.R")


## -----------------------------------------------------------------------------
package_dependencies("quollr")


## ----echo=TRUE----------------------------------------------------------------
scaled_nldr_obj_scurve <- gen_scaled_data(data = s_curve_noise_umap)

s_curve_noise_umap_scaled <- scaled_nldr_obj_scurve$scaled_nldr

lim1 <- scaled_nldr_obj_scurve$lim1
lim2 <- scaled_nldr_obj_scurve$lim2
r2 <- diff(lim2)/diff(lim1) 


## ----echo=TRUE----------------------------------------------------------------
fit_highd_model(
  highd_data = s_curve_noise_training,
  nldr_data = s_curve_noise_umap_scaled, 
  bin1 = 12, 
  r2 = r2,
  q = 0.1,
  is_bin_centroid = TRUE
  )


## ----echo=TRUE----------------------------------------------------------------
calc_bins_y(
  bin1 = 12, 
  r2 = r2,
  q = 0.1
  )


## ----echo=TRUE----------------------------------------------------------------
hex_binning(
  data = s_curve_noise_umap_scaled, 
  bin1 = 12, 
  r2 = r2,
  q = 0.1
  )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
# find_low_dens_hex(
#   df_bin_centroids_all = df_bin_centroids,
#   bin1 = 12,
#   df_bin_centroids_low = df_bin_centroids_low
#   )
# 


## ----echo=TRUE, eval=FALSE----------------------------------------------------
# tr1_object <- tri_bin_centroids(
#   hex_df = df_bin_centroids,
#   x = "c_x",
#   y = "c_y"
#   )
# 
# tr_from_to_df <- gen_edges(
#   tri_object = tr1_object
#   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
# find_lg_benchmark(
#   distance_edges = distance_df,
#   distance_col = "distance"
#   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
# umap_data_with_hb_id <- hb_obj$data_hb_id
# 
# df_all <- bind_cols(
#   s_curve_noise_training |> dplyr::select(-ID),
#   umap_data_with_hb_id
#   )
# 
# df_bin <- avg_highd_data(
#   data = df_all
#   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
# predict_emb(
#   highd_data = s_curve_noise_training,
#   model_2d = df_bin_centroids,
#   model_highd = df_bin
#   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
# glance(
#   highd_data = s_curve_noise_training,
#   model_2d = df_bin_centroids,
#   model_highd = df_bin
#   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
# augment(
#   highd_data = s_curve_noise_training,
#   model_2d = df_bin_centroids,
#   model_highd = df_bin
#   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
# ggplot() +
#   geom_hexgrid(
#     data = all_centroids_df,
#     aes(x = c_x, y = c_y)
#     ) +
#   coord_fixed()


## ----echo=TRUE, eval=FALSE----------------------------------------------------
# ggplot() +
#   geom_trimesh(
#     data = df_bin_centroids,
#     aes(x = c_x, y = c_y)
#     ) +
#   coord_fixed()


## ----echo=TRUE, eval=FALSE----------------------------------------------------
# vis_lg_mesh(
#   distance_edges = distance_df,
#   benchmark_value = 0.75,
#   tr_coord_df = tr_from_to_df,
#   distance_col = "distance"
#   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
# vis_rmlg_mesh(
#   distance_edges = distance_df,
#   benchmark_value = 0.75,
#   tr_coord_df = tr_from_to_df,
#   distance_col = "distance"
#   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
# show_langevitour(
#   df = df_all,
#   df_b = df_bin,
#   df_b_with_center_data = df_bin_centroids,
#   benchmark_value = 0.75,
#   distance = distance_df,
#   distance_col = "distance",
#   use_default_benchmark_val = FALSE,
#   col_start = "x"
#   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
# show_link_plots(
#   point_df = df_exe,
#   edge_df = distance_small_df
#   )


## ----echo=TRUE, eval=FALSE----------------------------------------------------
# show_error_link_plots(
#   point_df = df_exe,
#   edge_df = distance_small_df
#   )


## -----------------------------------------------------------------------------
#| label: read-limb-nldr
# Read a variety of different NLDR representations of limb
# and plot them on same aspect ratio
clr_choice <- "#0077A3"
umap_limb <- read_rds("data/limb_muscles/facs_limb_muscles_umap_n-neigbors_15_min-dist_0.1.rds")

nldr1 <- umap_limb |>
  ggplot(aes(x = emb1,
             y = emb2)) +
  geom_point(alpha=0.1, size=1, colour='#999999') +
  interior_annotation("a")

tsne_limb <- read_rds("data/limb_muscles/facs_limb_muscles_tsne_perplexity_30.rds")

nldr2 <- tsne_limb |>
  ggplot(aes(x = emb1,
             y = emb2)) +
  geom_point(alpha=0.1, size=1, colour='#a65628') +
  interior_annotation("b")

phate_limb <- read_rds("data/limb_muscles/facs_limb_muscles_phate_knn_5.rds")

nldr3 <- phate_limb |>
  ggplot(aes(x = emb1,
             y = emb2)) +
  geom_point(alpha=0.1, size=1, colour='#e41a1c') +
  interior_annotation("c")

trimap_limb <- read_rds("data/limb_muscles/facs_limb_muscles_trimap_n-inliers_12_n-outliers_4_n-random_3.rds")

nldr4 <- trimap_limb |>
  ggplot(aes(x = emb1,
             y = emb2)) +
  geom_point(alpha=0.1, size=1, colour='#377eb8') +
  interior_annotation("d")

pacmap_limb <- read_rds("data/limb_muscles/facs_limb_muscles_pacmap_n-neighbors_10_init_random_MN-ratio_0.5_FP-ratio_2.rds")

nldr5 <- pacmap_limb |>
  ggplot(aes(x = emb1,
             y = emb2)) +
  geom_point(alpha=0.1, size=1, colour='#4daf4a') +
  interior_annotation("e")

tsne_limb2 <- read_rds("data/limb_muscles/facs_limb_muscles_tsne_perplexity_15.rds")

nldr6 <- tsne_limb2 |>
  ggplot(aes(x = emb1,
             y = emb2)) +
  geom_point(alpha=0.1, size=1, colour='#ff7f00') +
  interior_annotation("f")


## -----------------------------------------------------------------------------
#| label: combine-error-data-muscles

error_limb_umap <- read_rds("data/limb_muscles/error_limb_muscles_umap_n-neigbors_15_min-dist_0.1.rds")
error_limb_tsne <- read_rds("data/limb_muscles/error_limb_muscles_tsne_perplexity_30.rds")
error_limb_phate <- read_rds("data/limb_muscles/error_limb_muscles_phate_knn_5.rds")
error_limb_trimap <- read_rds("data/limb_muscles/error_limb_muscles_trimap_n-inliers_12_n-outliers_4_n-random_3.rds")
error_limb_pacmap <- read_rds("data/limb_muscles/error_limb_muscles_pacmap_n-neighbors_10_init_random_MN-ratio_0.5_FP-ratio_2.rds")

error_limb_tsne2 <- read_rds("data/limb_muscles/error_limb_muscles_tsne_perplexity_15.rds")

error_limb <- bind_rows(error_limb_umap, 
                        error_limb_tsne,
                        error_limb_phate,
                        error_limb_trimap,
                        error_limb_pacmap,
                        error_limb_tsne2)

error_limb <- error_limb |>
  mutate(a1 = round(a1, 2)) |>
  filter(bin1 >= 5) |>
  filter(a1 >= 0.03) |>
  group_by(method, a1) |>
  filter(MSE == min(MSE)) |>
  ungroup()

error_limb <- error_limb |>
  mutate(method = factor(method,
                         levels = c("UMAP_15_min_dist_0.1","tsne_30", "phate_5", "trimap_n-inliers_12_n-outliers_4_n-random_3", "pacmap_n-neighbors_10_init_random_MN-ratio_0.5_FP-ratio_2", "tsne_15")))


## -----------------------------------------------------------------------------
#| label: error-comp-muscles

error_plot_limb <- plot_mse(error_limb) +
  scale_x_continuous(breaks = sort(unique(error_limb$a1))[c(1, 5, 9, 13, 17, 21, 26)]) +
  scale_color_manual(values=c('#999999','#a65628','#e41a1c','#377eb8','#4daf4a','#ff7f00','#984ea3','#f781bf')) 



## -----------------------------------------------------------------------------
#| fig-cap: ""
#| label: fig-limb-mse
#| out-width: 100%

free(error_plot_limb) + wrap_plots(
  nldr1, nldr2, nldr3, 
  nldr4, nldr5, nldr6, ncol = 2)


## -----------------------------------------------------------------------------
#| label: data-limb

training_data_limb <- read_rds("data/limb_muscles/facs_limb_muscles_pcs_10.rds")

cluster_df <- read_rds("data/limb_muscles/facs_limb_muscles_cluster_df.rds")


## -----------------------------------------------------------------------------
#| label: tsne-num-bins-limb

## Compute hexbin parameters
num_bins_x_limb <- 19

algo_obj_limb <- gen_nldr_vis_algo_obj(
  high_d_data = training_data_limb, 
  nldr_data = tsne_limb, 
  num_x_bins = num_bins_x_limb)

tsne_limb_scaled <- algo_obj_limb$nldr_scaled
distance_limb <- algo_obj_limb$distance_df
tr_from_to_df_limb <- algo_obj_limb$tr_from_to_df
benchmark_limb <- algo_obj_limb$benchmark
df_bin_centroids_limb <- algo_obj_limb$df_bin_centroids
df_bin_limb <- algo_obj_limb$df_bin

distance_df_small_edges_limb <- distance_limb |>
  filter(distance < 0.1) #benchmark_limb

tr_from_to_df_limb <- right_join(
  tr_from_to_df_limb, distance_df_small_edges_limb,
  by = c("from", "to")) 

tsne_limb_scaled_with_cluster <- inner_join(tsne_limb_scaled, cluster_df, by = "ID") |>
  mutate(cluster.ids = as.character(cluster.ids))

trimesh_removed_limb <- ggplot() + 
  geom_point(
    data = tsne_limb_scaled_with_cluster,
    aes(
      x = emb1,
      y = emb2,
      color = cluster.ids
    ),
    alpha = 0.3#,
    #color = "#a65628"
  ) +
    geom_segment(data = tr_from_to_df_limb, 
               aes(
                 x = x_from, 
                 y = y_from, 
                 xend = x_to, 
                 yend = y_to),
               colour = "#000000",
               linewidth = 1) +
  scale_color_manual(values = c('#66c2a5','#fc8d62','#8da0cb','#e78ac3','#a6d854','#ffd92f','#e5c494')) +
  interior_annotation("a1", cex = 2) +
  theme(
    aspect.ratio = 1
  )


## -----------------------------------------------------------------------------
#| label: prep-limb-tsne-author-model-proj

data_limb <- training_data_limb |> 
  select(-ID) |>
  mutate(type = "data")

df_b_limb <- df_bin_limb |>
  dplyr::filter(hb_id %in% df_bin_centroids_limb$hexID) |>
  dplyr::mutate(type = "model") ## Data with summarized mean

## Reorder the rows of df_b according to the hexID order in df_b_with_center_data
df_b_limb <- df_b_limb[match(df_bin_centroids_limb$hexID, df_b_limb$hb_id),] |>
  dplyr::select(-hb_id) 

# Apply the scaling
df_model_data_limb <- bind_rows(data_limb, df_b_limb)
scaled_limb <- scale_data_manual(df_model_data_limb, "type") |>
  as_tibble()

scaled_limb_data <- scaled_limb |>
  filter(type == "data") |>
  select(-type)

scaled_limb_data_model <- scaled_limb |>
  filter(type == "model") |>
  select(-type)


## -----------------------------------------------------------------------------
#| label: langevitour-limb-tsne-author-proj
#| eval: false

# data_limb_n <- data_limb |>
#   select(-type) |>
#   mutate(type = as.character(tsne_limb_scaled_with_cluster$cluster.ids))
# 
# df_model_data_limb_n <- bind_rows(df_b_limb, data_limb_n)
# 
# langevitour::langevitour(df_model_data_limb_n[1:(length(df_model_data_limb_n)-1)],
#                          lineFrom = distance_df_small_edges_limb$from,
#                          lineTo = distance_df_small_edges_limb$to,
#                          group = factor(df_model_data_limb_n$type,
#                                         c("0", "1", "2", "3", "4", "5", "6", "model")),
#                          levelColors = c('#66c2a5','#fc8d62','#8da0cb','#e78ac3','#a6d854','#ffd92f','#e5c494', "#000000"))


## -----------------------------------------------------------------------------
#| label: tsne-best-num-bins-limb

## Compute hexbin parameters
num_bins_x_limb <- 18

algo_obj_limb <- gen_nldr_vis_algo_obj(
  high_d_data = training_data_limb, 
  nldr_data = tsne_limb2, 
  num_x_bins = num_bins_x_limb)

tsne_limb_scaled_best <- algo_obj_limb$nldr_scaled
distance_limb <- algo_obj_limb$distance_df
tr_from_to_df_limb <- algo_obj_limb$tr_from_to_df
benchmark_limb <- algo_obj_limb$benchmark
df_bin_centroids_limb <- algo_obj_limb$df_bin_centroids
df_bin_limb <- algo_obj_limb$df_bin

distance_df_small_edges_limb <- distance_limb |>
  filter(distance < benchmark_limb) #benchmark_limb

tr_from_to_df_limb <- right_join(
  tr_from_to_df_limb, distance_df_small_edges_limb,
  by = c("from", "to")) 

tsne_limb_scaled_best_with_cluster <- inner_join(tsne_limb_scaled_best, cluster_df, by = "ID") |>
  mutate(cluster.ids = as.character(cluster.ids))


trimesh_removed_limb_best <- ggplot() + 
  geom_point(
    data = tsne_limb_scaled_best_with_cluster,
    aes(
      x = emb1,
      y = emb2,
      color = cluster.ids
    ),
    alpha = 0.3#,
    #color = "#ff7f00"
  ) +
    geom_segment(data = tr_from_to_df_limb, 
               aes(
                 x = x_from, 
                 y = y_from, 
                 xend = x_to, 
                 yend = y_to),
               colour = "#000000",
               linewidth = 1) +
  scale_color_manual(values = c('#66c2a5','#fc8d62','#8da0cb','#e78ac3','#a6d854','#ffd92f','#e5c494')) +
  interior_annotation("b1", cex = 2) +
  theme(
    aspect.ratio = 1
  )


## -----------------------------------------------------------------------------
#| label: prep-limb-tsne-best-model-proj

data_limb <- training_data_limb |> 
  select(-ID) |>
  mutate(type = "data")

df_b_limb <- df_bin_limb |>
  dplyr::filter(hb_id %in% df_bin_centroids_limb$hexID) |>
  dplyr::mutate(type = "model") ## Data with summarized mean

## Reorder the rows of df_b according to the hexID order in df_b_with_center_data
df_b_limb <- df_b_limb[match(df_bin_centroids_limb$hexID, df_b_limb$hb_id),] |>
  dplyr::select(-hb_id) 

# Apply the scaling
df_model_data_limb <- bind_rows(data_limb, df_b_limb)
scaled_limb <- scale_data_manual(df_model_data_limb, "type") |>
  as_tibble()

scaled_limb_data <- scaled_limb |>
  filter(type == "data") |>
  select(-type)

scaled_limb_data_model <- scaled_limb |>
  filter(type == "model") |>
  select(-type)


## -----------------------------------------------------------------------------
#| label: langevitour-limb-tsne-best-proj
#| eval: false

# df_model_data_limb_n <- bind_rows(df_b_limb, data_limb_n)
# 
# langevitour::langevitour(df_model_data_limb_n[1:(length(df_model_data_limb_n)-1)],
#                          lineFrom = distance_df_small_edges_limb$from,
#                          lineTo = distance_df_small_edges_limb$to,
#                          group = factor(df_model_data_limb_n$type,
#                                         c("0", "1", "2", "3", "4", "5", "6", "model")),
#                          levelColors = c('#66c2a5','#fc8d62','#8da0cb','#e78ac3','#a6d854','#ffd92f','#e5c494', "#000000"))


## -----------------------------------------------------------------------------
trimesh_removed_limb + trimesh_removed_limb_best +
  plot_layout(ncol = 3)

